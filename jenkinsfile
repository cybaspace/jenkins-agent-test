agentName = ""
COMMERCE_VERSION = ''

pipeline {
    agent none

    stages {
        stage('Prep') {
            steps {
                script {
                    COMMERCE_VERSION = sh (
                        script: 'grep commerceSuiteVersion manifest.json | cut -d\':\' -f2 |sed \'s/[",]//g\'',
                        returnStdout: true
                    ).trim()
                    agentName = "commerce-agent-" + COMMERCE_VERSION
                    if (! agentName.contains('.')) {
                      agentName += ':latest'
                    }
                    sh 'echo "Test" > test.txt'
                    sh 'ls -al'
                }
            }
        }
        stage('Checking') {
            steps {
                script {
                    println agentName
                    sh 'ls -al'
                }
            }
        }
        stage('Between') {
            agent { label agentName }

            steps {
                script {
                    println agentName
                    sh 'ls -al'
                }
            }
        }
        stage('Final') {
            agent { label agentName }

            steps {
                script {
                    println agentName
                    println COMMERCE_VERSION
                }
                echo "${COMMERCE_VERSION}"
            }
        }
    }
}
